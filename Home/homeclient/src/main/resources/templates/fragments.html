<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="de">

	<head><title></title></head>

	<!-- Titel -->
	<div th:fragment="title (name)"
		th:assert="${!#strings.isEmpty(name)}">
		<h4 style="font-size: 1.3rem; margin-top: 15px; letter-spacing: 2px;">
			<span th:text="${name}">Name</span>
		</h4>
	</div>
	
	<!-- Name -->
	<div th:fragment="elementname (icon, name, place, historyKey, unreach)">
		<th:block th:replace="fragments :: historyLink (key=${historyKey}, name=${name}, place=${place})"></th:block>
		<div>
			<a>
				<span th:if="${!#strings.isEmpty(icon)}"><th:block th:replace="basics :: symbol (name=${icon})"/></span>
				<span th:text="${name}"></span>
				<span th:if="${#strings.startsWith(unreach, 'true')}" class="text-danger">&nbsp;- Verbindungsfehler!</span>			
			</a>
		</div>
	</div>	

	<!-- WindowSensor -->
	<div th:fragment="windowsensor (model)" th:class="'alert alert-secondary callout callout-' + ${model.colorClass}">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4><span th:text="${model.state}"></span><span th:text="${model.stateSuffix}" style="font-size: 80%;"></span></h4>
	</div>

	<!-- Switch -->
	<div th:fragment="switch (model)" th:class="'alert alert-secondary callout callout-' + ${model.colorClass}">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4><span th:text="${model.state}"></span><span th:text="${model.stateSuffix}" style="font-size: 80%;"></span></h4>
		
		<div th:replace="fragments :: switchControls (model=${model})"></div>
	</div>

	<!-- PowerMeter with switch -->
	<div th:fragment="powerMeterWithSwitch (modelMeter, modelSwitch)" th:class="'alert alert-' + ${modelSwitch.colorClass} + ' callout callout-' + ${modelSwitch.colorClass}">
		<div th:replace="fragments :: elementname (icon=${modelMeter.icon}, name=${modelMeter.name} + ' ' + ${modelMeter.place}, place='', historyKey=${modelMeter.historyKey}, unreach=${modelMeter.unreach})"></div>
		<h4>
			<span th:text="${modelMeter.state}"></span>
			<th:block th:replace="fragments :: tendency (icon=${modelMeter.tendencyIcon})"></th:block>
			<th:block th:if="${modelMeter.todayConsumption != null}">
				<span th:utext="'&nbsp;&ndash;&nbsp;'"></span>
				<span class="mb-1" th:text="${modelMeter.todayConsumption.label}">Gestern</span>
				<span class="text-muted" style="font-size: 80%;" th:text="${modelMeter.todayConsumption.additionalLabel}">Summe</span>
			</th:block>		
		</h4>
		<h4><span th:text="${modelSwitch.state}"></span><span th:text="${modelSwitch.stateSuffix}" style="font-size: 80%;"></span></h4>
		<div th:replace="fragments :: switchControls (model=${modelSwitch})"></div>
	</div>

	<th:block th:fragment="switchControls (model)">

		<!-- on/off -->
		<div class="btn-group" role="group" aria-label="heating">
  			<button th:if="${#strings.startsWith(model.linkOn, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-check-circle')"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkOn, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToOn' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-check-circle')"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkOff, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-power-off')"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkOff, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToOff' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-power-off')"/></span><span>&nbsp;</span></button>
		</div>
		<input type="hidden" th:id="'val_model_linkOff_' + ${model.id}" th:value="${model.linkOff}">
		<input type="hidden" th:id="'val_model_linkOn_' + ${model.id}" th:value="${model.linkOn}">
 			<script type="text/javascript">
			function toggleToOn[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkOn_[[${model.id}]]').value);
			}
			function toggleToOff[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkOff_[[${model.id}]]').value);
			}	
		</script>
		
		<!-- auto/manual -->
		<th:block th:if="${!#strings.startsWith(model.linkAuto, '#') or !#strings.startsWith(model.linkManual, '#')}">
			<span>&nbsp;</span>
			<div class="btn-group" role="group" aria-label="heating">
	  			<button th:if="${#strings.startsWith(model.linkAuto, '#')}" type="button" class="btn btn-dark btn-sm">
	  				<span>&nbsp;</span>
	  				<span th:if="${#strings.isEmpty(model.buttonCaptionAuto)}"><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span>
	  				<span th:if="${!#strings.isEmpty(model.buttonCaptionAuto)}"><th:block th:text="${model.buttonCaptionAuto}"/></span>
  					<span>&nbsp;</span>
  				</button>
	  			<button th:if="${#strings.startsWith(model.linkAuto, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToAuto' + ${model.id} + '()'}">
	  				<span>&nbsp;</span>
	  				<span th:if="${#strings.isEmpty(model.buttonCaptionAuto)}"><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span>
	  				<span th:if="${!#strings.isEmpty(model.buttonCaptionAuto)}"><th:block th:text="${model.buttonCaptionAuto}"/></span>
  					<span>&nbsp;</span>
				</button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '#')}" type="button" class="btn btn-dark btn-sm">
	  				<span>&nbsp;</span>
	  				<span th:if="${#strings.isEmpty(model.buttonCaptionManual)}"><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span>
	  				<span th:if="${!#strings.isEmpty(model.buttonCaptionManual)}"><th:block th:text="${model.buttonCaptionManual}"/></span>
	  				<span>&nbsp;</span>
	  			</button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToManual' + ${model.id} + '()'}">
	  				<span>&nbsp;</span>
	  				<span th:if="${#strings.isEmpty(model.buttonCaptionManual)}"><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span>
	  				<span th:if="${!#strings.isEmpty(model.buttonCaptionManual)}"><th:block th:text="${model.buttonCaptionManual}"/></span>
	  				<span>&nbsp;</span>
	  			</button>
			</div>
			<input type="hidden" th:id="'val_model_linkManual_' + ${model.id}" th:value="${model.linkManual}">
			<input type="hidden" th:id="'val_model_linkAuto_' + ${model.id}" th:value="${model.linkAuto}">
  			<script type="text/javascript">
				function toggleToAuto[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkAuto_[[${model.id}]]').value);
				}
				function toggleToManual[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkManual_[[${model.id}]]').value);
				}	
			</script>
			<button type="button" class="btn btn-link" data-toggle="modal" th:data-target="'#modalAuto' + ${model.id}">
				<span 
					class="badge badge-secondary" th:text="'?'">
				</span>
			</button>
			<!-- Modal -->
			<div class="modal fade" th:id="'modalAuto' + ${model.id}" tabindex="-1" role="dialog" th:aria-labelledby="'#modalAutoLabel' + ${model.id}" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="exampleModalLongTitle" th:text="'Automatik: ' + ${model.name}"></h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body"><a th:utext="${model.autoInfoText}"></a></div>
			    </div>
			  </div>
			</div>
		</th:block>
	</th:block>
	
	<!-- Switch Settings-->
	<div th:fragment="switchSetting (model)" th:class="'alert alert-secondary callout callout-secondary'">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach='')"></div>
		<h4 th:text="${model.state}"></h4>
		
		<button type="button" th:onclick="@{'toggleSwitch' + ${model.id} + '()'}"
			class="btn btn-secondary btn-sm" th:text="${model.label}"></button>
		<input type="hidden" th:id="'val_model_link_' + ${model.id}" th:value="${model.link}">	
		<script type="text/javascript">
			function toggleSwitch[[${model.id}]](){
				submitSetting(document.getElementById('val_model_link_[[${model.id}]]').value);
			}		
		</script>	
	</div>	
	
	<!-- Window -->
	<div th:fragment="window (model)" th:class="'alert alert-secondary callout callout-secondary'">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4><span th:text="${model.state}"></span><span th:text="${model.stateSuffix}" style="font-size: 80%;"></span></h4>
		
		<div class="btn-group" role="group" aria-label="shutterControl">
  			<button th:if="${#strings.startsWith(model.linkOpen, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconOpen})"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkOpen, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'openShutter' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconOpen})"/></span><span>&nbsp;</span></button>
			<button th:if="${#strings.startsWith(model.linkHalf, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconHalf})"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkHalf, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'halfShutter' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconHalf})"/></span><span>&nbsp;</span></button>  			
  			<button th:if="${#strings.startsWith(model.linkSunshade, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconSUnshade})"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkSunshade, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'sunshadeShutter' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconSunshade})"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkClose, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconClose})"/></span><span>&nbsp;</span></button>
  			<button th:if="${#strings.startsWith(model.linkClose, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'closeShutter' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name=${model.iconClose})"/></span><span>&nbsp;</span></button>
		</div>		
		
		<input type="hidden" th:id="'val_model_linkOpen_' + ${model.id}" th:value="${model.linkOpen}">
		<input type="hidden" th:id="'val_model_linkClose_' + ${model.id}" th:value="${model.linkClose}">
		<input type="hidden" th:id="'val_model_linkHalf_' + ${model.id}" th:value="${model.linkHalf}">
		<input type="hidden" th:id="'val_model_linkSunshade_' + ${model.id}" th:value="${model.linkSunshade}">
		<script type="text/javascript">
			function openShutter[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkOpen_[[${model.id}]]').value);
			}
			function closeShutter[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkClose_[[${model.id}]]').value);
			}
			function halfShutter[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkHalf_[[${model.id}]]').value);
			}			
			function sunshadeShutter[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkSunshade_[[${model.id}]]').value);
			}			
		</script>
		
		<th:block th:if="${!#strings.startsWith(model.linkAuto, '#') or !#strings.startsWith(model.linkManual, '#')}">
			<span>&nbsp;</span>
			<div class="btn-group" role="group" aria-label="shutterMode">
	  			<button th:if="${#strings.startsWith(model.linkAuto, '#')}" type="button" class="btn btn-success btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkAuto, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleShutterToManual' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '#')}" type="button" class="btn btn-success btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleShutterToAuto' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span><span>&nbsp;</span></button>
			</div>
			<input type="hidden" th:id="'val_model_linkManual_' + ${model.id}" th:value="${model.linkManual}">
			<input type="hidden" th:id="'val_model_linkAuto_' + ${model.id}" th:value="${model.linkAuto}">
  			<script type="text/javascript">
				function toggleShutterToAuto[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkManual_[[${model.id}]]').value);
				}
				function toggleShutterToManual[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkAuto_[[${model.id}]]').value);
				}					
			</script>
				<button type="button" class="btn btn-link" data-toggle="modal" th:data-target="'#modalAuto' + ${model.id}">
					<span 
						class="badge badge-secondary" th:text="'?'">
					</span>
				</button>
				<!-- Modal -->
				<div class="modal fade" th:id="'modalAuto' + ${model.id}" tabindex="-1" role="dialog" th:aria-labelledby="'#modalAutoLabel' + ${model.id}" aria-hidden="true">
				  <div class="modal-dialog modal-dialog-centered" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLongTitle" th:text="'Automatik: ' + ${model.name}"></h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body"><a th:utext="${model.autoInfoText}"></a></div>
				    </div>
				  </div>
				</div>
		</th:block>
	</div>	

	<!-- Frontdoor -->
	<th:block th:fragment="frontDoor (model)">
		<div th:class="'alert alert-secondary callout callout-secondary'">
			<div th:replace="fragments :: elementname (icon='fas fa-bell', name='Türklingel', place='', historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
			<h4>
				<span th:text="${model.lastDoorbells}"></span>
			</h4>
		</div>
		<th:block th:if="${#strings.equals('x', 'y')}">
			<div th:class="'alert alert-secondary callout callout-secondary'">
				<div th:replace="fragments :: elementname (icon='fas fa-camera', name='Kamera', place='', historyKey=${model.historyKey}, unreach='')"></div>
				<div style="padding-top:6px;">
					<button th:id="${model.idLive} + 'Button'" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'buttonOnclick' + ${model.idLive} + '()'}"><span><th:block th:replace="basics :: symbol (name='fas fa-eye')"/></span><span>&nbsp;Aktuell</span></button>
					<a>&nbsp;</a>
					<button th:id="${model.idBell} + 'Button'" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'buttonOnclick' + ${model.idBell} + '()'}"><span><th:block th:replace="basics :: symbol (name='fas fa-eye')"/></span><span>&nbsp;Türklingel</span></button>
				</div>
			</div>	
			<th:block th:replace="fragments :: modalCamera (id=${model.idLive}, link=${model.linkLive}, linkRequest=${model.linkLiveRequest}, name='Aktuell', refresh='true')"></th:block>
			<th:block th:replace="fragments :: modalCamera (id=${model.idBell}, link=${model.linkBell}, linkRequest='', name='Türklingel', refresh='false')"></th:block>
		</th:block>
	</th:block>	
	
	<!-- Modal Camera -->
	<th:block th:fragment="modalCamera (id, link, linkRequest, name, refresh)">
		<input type="hidden" th:id="'modalCameraHiddenLink' + ${id}" th:value="${link}">
		<div class="modal fade" th:id="'modalCamera' + ${id}" tabindex="-1" role="dialog" th:aria-labelledby="'#modalCamera' + ${id}" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" th:id="'modalCameraId' + ${id}" th:text="${name}"></h5>
		        <button type="button" class="close" th:onclick="@{'closeOnclick' + ${id} + '()'}" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
				<img th:id="'cameraImage' + ${id}" style="width:100%;" alt=""/>			  
			  </div>
		      <div th:if="${#strings.equals(refresh,'true')}" class="modal-footer">
		        <button th:id="${id} + 'Refresh'" type="button" th:onclick="@{'refreshOnclick' + ${id} + '()'}" class="btn btn-default btn-sm">Aktualisieren</button>
		      </div>			  
		    </div>
		  </div>
		</div>	
		<script type="text/javascript">
			var link[[${id}]] = '';
			var ts[[${id}]] = '';
			var timer[[${id}]] = null;
			var beacon[[${id}]] = new Image(); 
			beacon[[${id}]].onload = function() {	
			    console.log('Image found ' + ts[[${id}]]); 
			    clearTimeout(timer[[${id}]]);
			    timer[[${id}]] = null;
			    $('#cameraImage[[${id}]]').attr('src', link[[${id}]] + ts[[${id}]]);
			    if(ts[[${id}]] > 0){
				    var timestring = new Date(new Number(ts[[${id}]])).toLocaleTimeString('de-DE');
				    console.log('title#' + timestring + ' / ' + ts[[${id}]]); 
				    // $("#modalCameraId[[${id}]]").innerHTML = ('Aktuell (' + timestring + ')');
				    document.getElementById('modalCameraId[[${id}]]').innerHTML = 'Aktuell (' + timestring + ')';
			    }
			};
			beacon[[${id}]].onerror = function(){
			   console.log('Image not found');
			   clearTimeout(timer[[${id}]]);
			   timer[[${id}]] = null;
			   poll[[${id}]]();
			}
			function prepare[[${id}]]Button(show, request){
				console.log('Prepare Button');
				// show modal
				if(show==='true'){
					$("#modalCamera[[${id}]]").modal("show"); 
				}
				// request new live picture
				if(request==='true'){
						console.log('New request');
						var httpRequest = new XMLHttpRequest();
						httpRequest.open("GET", "[(${linkRequest})]");
						httpRequest.send();
						httpRequest.onreadystatechange=(e)=>{
							if (httpRequest.readyState == 4 && httpRequest.status == 200) {
								console.log('Response=' + httpRequest.responseText);
								ts[[${id}]] = httpRequest.responseText;
								// beacon[[${id}]] = new Image(); 
								poll[[${id}]]();
							}
						}
				}else{
					poll[[${id}]]();
				}	
			}
			function poll[[${id}]](){
				//if(timer[[${id}]]!==null){
				//	console.log('no timer - return');
				//	return;
				// }
				timer[[${id}]] = setTimeout(function(){ 
					if($('.modal.fade.show').length !== 0){
						link[[${id}]] = document.getElementById('modalCameraHiddenLink[[${id}]]').value;
						console.log('poll...' + link[[${id}]] + ts[[${id}]] + '//' + beacon[[${id}]]);
						beacon[[${id}]].src = link[[${id}]] + ts[[${id}]] + "&onlyheader=true";
					}
				}, 500);
			}
			
			// $("#modalCamera[[${id}]]").on('hide.bs.modal', function(){
			function closeOnclick[[${id}]](){
				// beacon[[${id}]] = null;
				ts[[${id}]] = '';
				$("#cameraImage[[${id}]]").attr("src", "");
				if(timer[[${id}]]!=null){
					clearTimeout(timer[[${id}]]);
					timer[[${id}]] = setTimeout(function(){ 
						console.log('finish timer');
					}, 0);
				}
			} // );
			// document.getElementById("[[${id}]]Button").onclick = function () {
			function buttonOnclick[[${id}]](){
				console.log('buttonOnclick... [[${id}]]');
				$("#cameraImage[[${id}]]").attr("src", "loading.jpg");
				if($('.modal.fade.show').length === 0){
					$("#cameraImage[[${id}]]").attr("src", "loading.png");
					prepare[[${id}]]Button('true', '[[${refresh}]]');
				}
			}// ;
			// if([[${refresh}]]===true){
				//document.getElementById("[[${id}]]Refresh").onclick = function () {
				function refreshOnclick[[${id}]](){
					$("#cameraImage[[${id}]]").attr("src", "loading.png");
					prepare[[${id}]]Button('false', 'true');
				} // ;
			// }
		</script>				
	</th:block>	
	
	<!-- Front door lock -->
	<div th:fragment="doorLock (model)" th:class="'alert alert-' + ${model.colorClass} + ' callout callout-' + ${model.colorClass}">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4 th:unless="${#strings.equals(model.busy,'true')}"><span th:text="${model.state}"></span><span th:text="${model.stateSuffix}" style="font-size: 80%;"></span></h4>

		<th:block th:unless="${#strings.equals(model.busy,'true')}">	
			<div class="btn-group" role="group" aria-label="lockcontrol">
	  			<button th:if="${#strings.startsWith(model.linkLock, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-lock')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkLock, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'openPin' + ${model.id} + '(lockModalLabel' + ${model.id} + ', lock' + ${model.id} + ')'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-lock')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkUnlock, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-lock-open')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkUnlock, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'openPin' + ${model.id} + '(unlockModalLabel' + ${model.id} + ', unlock' + ${model.id} + ')'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-lock-open')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkOpen, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-door-open')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkOpen, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'openPin' + ${model.id} + '(openModalLabel' + ${model.id} + ', open' + ${model.id} + ')'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-door-open')"/></span><span>&nbsp;</span></button>
			</div>
		</th:block>
		<input type="hidden" th:id="'val_model_linkLock_' + ${model.id}" th:value="${model.linkLock}">
		<input type="hidden" th:id="'val_model_linkUnlock_' + ${model.id}" th:value="${model.linkUnlock}">
		<input type="hidden" th:id="'val_model_linkOpen_' + ${model.id}" th:value="${model.linkOpen}">
 		<script type="text/javascript">
			function lockModalLabel[[${model.id}]](){
				return '[[${model.caption}]] verriegeln';
			}
			function unlockModalLabel[[${model.id}]](){
				return '[[${model.caption}]] entriegeln';
			}	
			function openModalLabel[[${model.id}]](){
				return '[[${model.caption}]] öffnen';
			} 		
			function lock[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkLock_[[${model.id}]]').value + document.getElementById('val_pin_[[${model.id}]]').value);
			}
			function unlock[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkUnlock_[[${model.id}]]').value + document.getElementById('val_pin_[[${model.id}]]').value);
			}	
			function open[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkOpen_[[${model.id}]]').value + document.getElementById('val_pin_[[${model.id}]]').value);
			}			
		</script>		
		
		<span>&nbsp;</span>
		<th:block th:unless="${#strings.equals(model.busy,'true')}">
			<div class="btn-group" role="group" aria-label="lockauto">
	  			<button th:if="${#strings.startsWith(model.linkAutoEvent, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-bell')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkAutoEvent, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToAutoEvent' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-bell')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkAuto, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkAuto, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToAuto' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-cogs')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '#')}" type="button" class="btn btn-dark btn-sm"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span><span>&nbsp;</span></button>
	  			<button th:if="${#strings.startsWith(model.linkManual, '/')}" type="button" class="btn btn-secondary btn-sm" th:onclick="@{'toggleToManual' + ${model.id} + '()'}"><span>&nbsp;</span><span><th:block th:replace="basics :: symbol (name='fas fa-hand-paper')"/></span><span>&nbsp;</span></button>
			</div>
			<input type="hidden" th:id="'val_model_linkManual_' + ${model.id}" th:value="${model.linkManual}">
			<input type="hidden" th:id="'val_model_linkAuto_' + ${model.id}" th:value="${model.linkAuto}">
			<input type="hidden" th:id="'val_model_linkAutoEvent_' + ${model.id}" th:value="${model.linkAutoEvent}">
  			<script type="text/javascript">
				function toggleToAutoEvent[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkAutoEvent_[[${model.id}]]').value);
				}  			
				function toggleToAuto[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkAuto_[[${model.id}]]').value);
				}
				function toggleToManual[[${model.id}]](){
					submitContent(document.getElementById('val_model_linkManual_[[${model.id}]]').value);
				}	
			</script>
			<button type="button" class="btn btn-link" data-toggle="modal" th:data-target="'#modalAuto' + ${model.id}">
				<span 
					class="badge badge-secondary" th:text="'?'">
				</span>
			</button>
			<!-- Modal -->
			<div class="modal fade" th:id="'modalAuto' + ${model.id}" tabindex="-1" role="dialog" th:aria-labelledby="'#modalAutoLabel' + ${model.id}" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" th:text="'Automatik: ' + ${model.name}"></h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body"><a th:utext="${model.autoInfoText}"></a></div>
			    </div>
			  </div>
			</div>
		</th:block>
		
		<th:block th:if="${#strings.equals(model.busy,'true')}">
			<h4><span><th:block th:replace="basics :: symbol (name='fa fa-spinner fa-spin')"/></span></h4>
		</th:block>
					
		<div th:replace="pin :: pin (id=${model.id})"></div>
		
	</div>	
	
	<!-- Actual Power Consumption -->
	<div th:fragment="actualPowerConsumption (model)" th:class="'alert alert-secondary callout callout-secondary'">

		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name} + ' Gesamt', place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4>
			<span th:text="${model.state}"></span>
			<th:block th:replace="fragments :: tendency (icon=${model.tendencyIcon})"></th:block>
			<th:block th:if="${model.todayConsumption != null}">
				<span th:utext="'&nbsp;&ndash;&nbsp;'"></span>
				<span class="mb-1" th:text="${model.todayConsumption.label}">Gestern</span>
				<span class="text-muted" style="font-size: 80%;" th:text="${model.todayConsumption.additionalLabel}">Summe</span>
			</th:block>		
		</h4>
		
		<th:block th:if="${model.todayConsumption != null}">
			<div style="max-width:80%;">
				<div style="max-width:400px;">
					<div th:replace="fragments :: chartEntry (chart=${model.todayConsumption}, showCaption='false')"></div>
				</div>
			</div>
		</th:block>
	</div>	
	
	<!-- History link -->
	<div th:fragment="historyLink (key, name, place)">
		<th:block th:if="${!#strings.isEmpty(key)}">
			<div style="float:right; position:relative;" th:onclick="@{'openHistory' + ${key} + '()'}">
				<button type="button" class="btn btn-link">
					<span class="badge badge-secondary" style="font-size: 100% !important; padding: 5px !important;">
						<th:block th:replace="basics :: symbol (name='fas fa-history')"/>
					</span>
				</button>			
			</div>
			<div class="modal fade" th:id="'modalHistory' + ${key}" tabindex="-1" role="dialog" th:aria-labelledby="'#modalCamera' + ${key}" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title text-dark" th:id="'modalHistoryId' + ${key}" th:text="${name} + ' ' + ${place}"></h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div th:id="'modalHistoryBody' + ${key}" class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;"></div>
			    </div>
			  </div>
			</div>		
			<script type="text/javascript">
				function openHistory[[${key}]](){
					$("#modalHistory[[${key}]]").modal();
					var httpRequest = new XMLHttpRequest();
					httpRequest.open("GET", "/history?key=[[${key}]]");
					httpRequest.send();
					httpRequest.onreadystatechange=(e)=>{
						if (httpRequest.readyState == 4 && httpRequest.status == 200) {
							document.getElementById("modalHistoryBody[[${key}]]").innerHTML = httpRequest.responseText;
						}
					}
				}
			</script>
		</th:block>
	</div>		
	
	<!-- Tendency icon -->
	<th:block th:fragment="tendency (icon)">
	     <span th:if="${!#strings.isEmpty(icon)}"><th:block th:replace="basics :: symbolWithStyle (name=${icon}, style='font-size: 80%;')"/></span>
	</th:block>

	<!-- Temperature -->
	<div th:fragment="temperature (model)" th:class="'alert alert-' + ${model.colorClass} + ' callout callout-' + ${model.colorClass}">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name='Temperatur' + ${model.postfix}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4>
			<span th:if="${!#strings.isEmpty(model.stateTemperature)}" th:text="${model.stateTemperature}"></span>
			<th:block th:replace="fragments :: tendency (icon=${model.tendencyIconTemperature})"></th:block>
			<span th:if="${!#strings.isEmpty(model.statePostfixIconTemperature)}"><th:block th:replace="basics :: symbol (name=${model.statePostfixIconTemperature})"/></span>
			<span th:if="${!#strings.isEmpty(model.stateHumidity)}" th:utext="'&nbsp;&ndash;&nbsp;'"></span>
			<span th:if="${!#strings.isEmpty(model.stateHumidity)}" th:text="${model.stateHumidity}"></span>
			<th:block th:replace="fragments :: tendency (icon=${model.tendencyIconHumidity})"></th:block>
			<span th:if="${!#strings.isEmpty(model.statePostfixIconHumidity)}"><th:block th:replace="basics :: symbol (name=${model.statePostfixIconHumidity})"/></span>
			<span th:if="${!#strings.isEmpty(model.absoluteHumidityIcon)}" th:utext="'&hairsp;'"></span>
			<span onclick="$('#idDropSymbolMessage').modal();" th:if="${!#strings.isEmpty(model.absoluteHumidityIcon)}"><th:block th:replace="fragments :: tendency (icon=${model.absoluteHumidityIcon})"/></span>
						
		</h4>
			
		<th:block th:each="hint : ${model.hints}">
			<div>
				<a th:class="'font-weight-light'" style="font-size: 85%; margin-right:10px;">
					<span th:if="${#strings.startsWith(hint,'ggf')}"><th:block th:replace="basics :: symbol (name='far fa-hand-point-right')"/></span>
					<span th:unless="${#strings.startsWith(hint,'ggf')}"><th:block th:replace="basics :: symbol (name='fas fa-hand-point-right')"/></span>
					<span th:text="${hint}">hint</span>
				</a>
			</div>
		</th:block>	
	</div>
	
	<!-- Thermostat -->
	<div th:fragment="thermostat (model)" th:class="'alert alert-' + ${model.colorClassHeating} + ' callout callout-' + ${model.colorClassHeating}">
		<div th:replace="fragments :: elementname (icon=${model.heatericon}, name='Heizkörpersteuerung', place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
			
		<th:block th:unless="${#strings.equals(model.busy,'true')}">	
			<h4 th:if="${#strings.startsWith(model.linkBoost,'/')}"><span th:text="'Manuell auf ' + ${model.targetTemp} + '°C'"></span></h4>
			<h4 th:unless="${#strings.startsWith(model.linkBoost,'/')}"><span th:text="'Aufheizen - noch ' + ${model.linkBoost} + ' Min.'"></span></h4>
				<div th:if="${#strings.startsWith(model.linkBoost,'/')}" class="btn-group" role="group" aria-label="heating">
		  			<button type="button" th:id="'idHeatMinus' + ${model.id}" class="btn btn-secondary btn-sm" th:onclick="@{'adjustHeating' + ${model.id} + '(-0.5)'}">&nbsp;-&nbsp;</button>
		  			<button type="button" th:id="'idHeatTarget' + ${model.id}" class="btn btn-outline-secondary btn-sm" disabled><span th:id="'idHeatTargetLabel' + ${model.id}" th:text="${model.targetTemp}"></span><span>°C</span></button>
		  			<button type="button" th:id="'idHeatPlus' + ${model.id}" class="btn btn-secondary btn-sm" th:onclick="@{'adjustHeating' + ${model.id} + '(+0.5)'}">&nbsp;+&nbsp;</button>
				</div>
			<span th:if="${#strings.startsWith(model.linkBoost,'/')}">&nbsp;</span>
			
			<button th:if="${#strings.startsWith(model.linkBoost,'/')}"
				type="button" th:onclick="@{'setBoost' + ${model.id} + '()'}" class="btn btn-secondary btn-sm">Schnell aufheizen</button>
			<button th:unless="${#strings.startsWith(model.linkBoost,'/')}" type="button"
				class="btn btn-secondary btn-sm" th:onclick="@{'setHeating' + ${model.id} + '()'}" th:text="'abbrechen'">Boost ist eingeschaltet</button>
			<input type="hidden" th:id="'val_model_targetTemp_' + ${model.id}" th:value="${model.targetTemp}">
			<input type="hidden" th:id="'val_model_linkManual_' + ${model.id}" th:value="${model.linkManual}">
			<input type="hidden" th:id="'val_model_linkBoost_' + ${model.id}" th:value="${model.linkBoost}">
		</th:block>
		<th:block th:if="${#strings.equals(model.busy,'true')}">
			<h4><span><th:block th:replace="basics :: symbol (name='fa fa-spinner fa-spin')"/></span></h4>
		</th:block>
		<script type="text/javascript">
			var timeout[[${model.id}]] = null;
			var newTargetTemp[[${model.id}]] = parseFloat(document.getElementById('val_model_targetTemp_[[${model.id}]]').value.replace(/,/, '.'));
			function adjustHeating[[${model.id}]](diff){
				if(timeout[[${model.id}]]){
					clearTimeout(timeout[[${model.id}]]);
				}
				newTargetTemp[[${model.id}]] = newTargetTemp[[${model.id}]] + diff;
				document.getElementById("idHeatTarget[[${model.id}]]").className = "btn btn-danger btn-sm";
				document.getElementById("idHeatTargetLabel[[${model.id}]]").innerHTML = newTargetTemp[[${model.id}]].toFixed(1).replace('.', ',');
				timeout[[${model.id}]] = setTimeout(setHeating[[${model.id}]], 1000 * 1.5);
			}
			function setHeating[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkManual_[[${model.id}]]').value + "&value=" + newTargetTemp[[${model.id}]]);
			}
			function setBoost[[${model.id}]](){
				submitContent(document.getElementById('val_model_linkBoost_[[${model.id}]]').value);
			}			
		</script>
	</div>	

	<!-- Sonne -->
	<div th:fragment="sunStatus (model)" th:if="${!#strings.isEmpty(model.stateTemperature)}" th:class="'alert alert-' + ${model.colorClass} + ' callout callout-' + ${model.colorClass}">
		<div th:replace="fragments :: elementname (icon=${model.icon}, name=${model.name}, place=${model.place}, historyKey=${model.historyKey}, unreach=${model.unreach})"></div>
		<h4 th:text="${model.stateTemperature}"></h4>
	</div>

	<!-- AllgemeineWarnung -->
	<th:block th:fragment="generalWarning (model)">
		<th:block th:if="${#lists.size(model) &gt; 0}">
			<div th:replace="fragments :: title (name='Achtung!')"></div>
		</th:block>
		<th:block th:each="entry : ${model}">
			<div th:class="'alert alert-danger callout callout-danger classHomeWarning'">
				<h4>
					<span><th:block th:replace="basics :: symbol (name='fas fa-exclamation-triangle')"/></span> <span th:text="${entry}"></span>
				</h4>
			</div>
		</th:block>	
	</th:block>

	<!-- Batterie-Warnung -->
	<th:block th:fragment="deviceBatterieWarning (model)">
		<th:block th:if="${#lists.size(model) &gt; 0}">
			<div th:replace="fragments :: title (name='Bitte beachten:')"></div>
		</th:block>
		<th:block th:each="entry : ${model}">
			<div th:class="'alert alert-warning callout callout-warning classHomeWarning'">
				<h4>
					<span><th:block th:replace="basics :: symbol (name='fas fa-battery-quarter')"/></span> <span
						th:text="'Batterie fast leer: ' + ${entry}"></span>
				</h4>
			</div>
		</th:block>	
	</th:block>
	
	<!-- Chart Entry -->
	<th:block th:fragment="chartEntry (chart, showCaption)">	
		<th:block th:if="${#strings.equals(showCaption,'true')}">
			<a th:class="${chart.collapse}">
				<span class="mb-1" th:text="${chart.label}">Gestern</span>
				<span>&nbsp;</span>
				<span class="text-muted" style="font-size: 80%;" th:text="${chart.additionalLabel}">Summe</span>
			</a>
		</th:block>
		<div th:class="'progress' + ${chart.collapse}" style="margin-bottom: 10px !important; margin-top: 4px !important">
			<th:block th:each="valueWithCaption : ${chart.valuesWithCaptions}">
				<div th:class="'progress-bar' + ${valueWithCaption.cssClass}" role="progressbar" th:style="'width: ' + ${valueWithCaption.value} + '%;'" th:aria-valuenow="${valueWithCaption.value}" aria-valuemin="0" aria-valuemax="100" th:text="${valueWithCaption.caption}"></div> 
			</th:block>
		</div>	
	</th:block>

</body>
</html>